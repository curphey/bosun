name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Plugin
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install -g ajv-cli jsonlint

      - name: Validate plugin.json
        run: jsonlint -q .claude-plugin/plugin.json

      - name: Validate findings schema
        run: |
          jsonlint -q schemas/findings.schema.json
          # Validate schema is valid JSON Schema
          ajv compile -s schemas/findings.schema.json

      - name: Validate upstream-sources.json
        run: |
          if [ -f references/upstream-sources.json ]; then
            jsonlint -q references/upstream-sources.json
          fi

  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: |
          markdownlint '**/*.md' \
            --ignore node_modules \
            --ignore .cache \
            --config .markdownlint.json

  lint-shell:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          find scripts -name "*.sh" -type f -exec shellcheck {} \;

  validate-frontmatter:
    name: Validate YAML Frontmatter
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yaml parser
        run: npm install -g js-yaml

      - name: Validate agent frontmatter
        run: |
          echo "Validating agent frontmatter..."
          for file in agents/*.md; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              # Extract YAML frontmatter and validate
              sed -n '/^---$/,/^---$/p' "$file" | head -n -1 | tail -n +2 | js-yaml > /dev/null
              if [ $? -ne 0 ]; then
                echo "Invalid YAML in $file"
                exit 1
              fi

              # Check required fields
              if ! grep -q "^name:" "$file"; then
                echo "Missing 'name' in $file"
                exit 1
              fi
              if ! grep -q "^description:" "$file"; then
                echo "Missing 'description' in $file"
                exit 1
              fi
              if ! grep -q "^tools:" "$file"; then
                echo "Missing 'tools' in $file"
                exit 1
              fi
            fi
          done

      - name: Validate skill frontmatter
        run: |
          echo "Validating skill frontmatter..."
          for file in skills/*/SKILL.md; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              sed -n '/^---$/,/^---$/p' "$file" | head -n -1 | tail -n +2 | js-yaml > /dev/null
              if [ $? -ne 0 ]; then
                echo "Invalid YAML in $file"
                exit 1
              fi

              if ! grep -q "^name:" "$file"; then
                echo "Missing 'name' in $file"
                exit 1
              fi
            fi
          done

      - name: Validate command frontmatter
        run: |
          echo "Validating command frontmatter..."
          for file in commands/*.md; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              sed -n '/^---$/,/^---$/p' "$file" | head -n -1 | tail -n +2 | js-yaml > /dev/null
              if [ $? -ne 0 ]; then
                echo "Invalid YAML in $file"
                exit 1
              fi

              if ! grep -q "^name:" "$file"; then
                echo "Missing 'name' in $file"
                exit 1
              fi
            fi
          done

  structure-check:
    name: Check Plugin Structure
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Verify required files exist
        run: |
          echo "Checking required files..."

          required_files=(
            ".claude-plugin/plugin.json"
            "CLAUDE.md"
            "README.md"
            "schemas/findings.schema.json"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Missing required file: $file"
              exit 1
            fi
            echo "✓ $file"
          done

      - name: Verify required directories exist
        run: |
          echo "Checking required directories..."

          required_dirs=(
            "agents"
            "skills"
            "commands"
            "scripts"
          )

          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "Missing required directory: $dir"
              exit 1
            fi
            echo "✓ $dir/"
          done

      - name: Count plugin components
        run: |
          echo ""
          echo "Plugin Component Summary:"
          echo "========================="
          echo "Agents:   $(find agents -name '*.md' | wc -l | tr -d ' ')"
          echo "Skills:   $(find skills -name 'SKILL.md' | wc -l | tr -d ' ')"
          echo "Commands: $(find commands -name '*.md' | wc -l | tr -d ' ')"
          echo "Scripts:  $(find scripts -name '*.sh' | wc -l | tr -d ' ')"

  run-tests:
    name: Run Test Suite
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Install ajv-cli for schema validation
        run: npm install -g ajv-cli ajv-formats

      - name: Run test suite
        run: ./tests/run-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/
          retention-days: 7

  consistency-checks:
    name: Consistency Checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Check marketplace.json matches skills directory
        run: |
          echo "Checking marketplace.json skills match skills/ directory..."

          # Get skills from marketplace.json
          marketplace_skills=$(jq -r '.skills[]' marketplace.json | sed 's|skills/||' | sort)

          # Get actual skill directories
          actual_skills=$(find skills -maxdepth 1 -type d -name 'bosun-*' | sed 's|skills/||' | sort)

          # Compare
          missing_in_marketplace=""
          missing_in_directory=""

          for skill in $actual_skills; do
            if ! echo "$marketplace_skills" | grep -q "^$skill$"; then
              missing_in_marketplace="$missing_in_marketplace $skill"
            fi
          done

          for skill in $marketplace_skills; do
            if ! echo "$actual_skills" | grep -q "^$skill$"; then
              missing_in_directory="$missing_in_directory $skill"
            fi
          done

          if [ -n "$missing_in_marketplace" ]; then
            echo "ERROR: Skills in directory but not in marketplace.json:$missing_in_marketplace"
            exit 1
          fi

          if [ -n "$missing_in_directory" ]; then
            echo "ERROR: Skills in marketplace.json but not in directory:$missing_in_directory"
            exit 1
          fi

          echo "✓ All $(echo "$actual_skills" | wc -w | tr -d ' ') skills match"

      - name: Check agents reference existing skills
        run: |
          echo "Checking agent skill references..."

          errors=0

          for agent_file in agents/*.md; do
            if [ -f "$agent_file" ]; then
              agent_name=$(basename "$agent_file")

              # Extract skills array from frontmatter
              skills_line=$(grep "^skills:" "$agent_file" | head -1 || echo "")

              if [ -n "$skills_line" ]; then
                # Parse skills from YAML array format [skill1, skill2]
                skills=$(echo "$skills_line" | sed 's/skills: \[//' | sed 's/\]//' | sed 's/,//g')

                for skill in $skills; do
                  if [ -n "$skill" ] && [ ! -d "skills/$skill" ]; then
                    echo "ERROR: $agent_name references non-existent skill: $skill"
                    errors=$((errors + 1))
                  fi
                done
              fi
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "Found $errors invalid skill references"
            exit 1
          fi

          echo "✓ All agent skill references valid"

      - name: Check required SKILL.md files exist
        run: |
          echo "Checking each skill has SKILL.md..."

          errors=""

          for skill_dir in skills/bosun-*/; do
            if [ -d "$skill_dir" ]; then
              skill_name=$(basename "$skill_dir")
              if [ ! -f "${skill_dir}SKILL.md" ]; then
                errors="$errors\n  $skill_name missing SKILL.md"
              fi
            fi
          done

          if [ -n "$errors" ]; then
            echo "ERROR: Missing SKILL.md files:"
            echo -e "$errors"
            exit 1
          fi

          skill_count=$(find skills -maxdepth 1 -type d -name 'bosun-*' | wc -l | tr -d ' ')
          echo "✓ All $skill_count skills have SKILL.md"

      - name: Check version consistency
        run: |
          echo "Checking version consistency..."

          # Get version from marketplace.json
          marketplace_version=$(jq -r '.version' marketplace.json)

          # Get version from plugin.json
          plugin_version=$(jq -r '.version' .claude-plugin/plugin.json)

          if [ "$marketplace_version" != "$plugin_version" ]; then
            echo "ERROR: Version mismatch"
            echo "  marketplace.json: $marketplace_version"
            echo "  plugin.json: $plugin_version"
            exit 1
          fi

          echo "✓ Versions match: $marketplace_version"

      - name: Summary
        run: |
          echo ""
          echo "=== Consistency Check Summary ==="
          echo "Skills:     $(find skills -maxdepth 1 -type d -name 'bosun-*' | wc -l | tr -d ' ')"
          echo "Agents:     $(find agents -name '*.md' | wc -l | tr -d ' ')"
          echo "Commands:   $(find commands -name '*.md' | wc -l | tr -d ' ')"
          echo "Version:    $(jq -r '.version' marketplace.json)"
          echo "================================"
