# Yarn Package Manager

**Ecosystem**: JavaScript/Node.js
**Package Registry**: https://registry.yarnpkg.com (mirrors npmjs.org)
**Documentation**: https://yarnpkg.com/

---

## Version Differences

| Version | Lock File | Key Features |
|---------|-----------|--------------|
| Yarn Classic (1.x) | `yarn.lock` | Flat node_modules |
| Yarn Berry (2.x+) | `yarn.lock` | Plug'n'Play, Zero-Installs |

---

## TIER 1: Manifest Detection

### Manifest Files

| File | Required | Description |
|------|----------|-------------|
| `package.json` | Yes | Primary manifest (shared with npm) |
| `.yarnrc` | No | Yarn Classic configuration |
| `.yarnrc.yml` | No | Yarn Berry configuration |

### Package.json Detection

**Pattern**: `package.json$`
**Confidence**: 95% (HIGH)

**Yarn-Specific Indicators**:
- Presence of `yarn.lock`
- `packageManager` field in package.json
- `.yarnrc` or `.yarnrc.yml` files

### Dependency Types

| Field | Included in SBOM | Notes |
|-------|------------------|-------|
| `dependencies` | Yes (always) | Production runtime |
| `devDependencies` | Configurable | Development only |
| `peerDependencies` | Yes | Expected by consumer |
| `optionalDependencies` | Configurable | May fail without error |
| `resolutions` | Yes | Version overrides |

---

## TIER 2: Lock File Detection

### Lock File

| File | Format | Version |
|------|--------|---------|
| `yarn.lock` | Custom YAML-like | v1 (Classic), v6+ (Berry) |

**Pattern**: `yarn\.lock$`
**Confidence**: 98% (HIGH)

### Yarn Classic Lock Structure (v1)

```yaml
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1

express@^4.18.0:
  version "4.18.2"
  resolved "https://registry.yarnpkg.com/express/-/express-4.18.2.tgz#3fabe08296e930c796c19e3c516979386ba9fd59"
  integrity sha512-5/PsL6iGPdfQ/lKM1UuielYgv3BUoJfz1aUwU9vHZ+J7gyvwdQXFEBIEIaxeGf0GIcreATNyBExtalisDbuMqQ==
  dependencies:
    accepts "~1.3.8"
    array-flatten "1.1.1"
```

### Yarn Berry Lock Structure (v6+)

```yaml
# This file is generated by running "yarn install" inside your project.
# Manual changes might be lost - proceed with caution!

__metadata:
  version: 6
  cacheKey: 8

"express@npm:^4.18.0":
  version: 4.18.2
  resolution: "express@npm:4.18.2"
  checksum: 3c4b9b0768...
  dependencies:
    accepts: ~1.3.8
    array-flatten: 1.1.1
```

### Key Lock File Fields

| Field | SBOM Use |
|-------|----------|
| `version` | Exact package version |
| `resolved` | Download URL |
| `integrity` | SHA-512 hash |
| `checksum` | Yarn Berry checksum |
| `dependencies` | Transitive dependencies |

---

## TIER 3: Configuration Extraction

### Registry Configuration

**File**: `.yarnrc.yml` (Berry) or `.yarnrc` (Classic)

**Berry Pattern**: `npmRegistryServer:\s*['\"]?([^\s'\"]+)`
**Classic Pattern**: `registry\s+['\"]?([^\s'\"]+)`

### Yarn Berry Configuration

```yaml
# .yarnrc.yml
nodeLinker: node-modules  # or pnp

npmRegistryServer: "https://npm.mycompany.com/"

npmScopes:
  mycompany:
    npmRegistryServer: "https://npm.mycompany.com/"
    npmAuthToken: "${NPM_TOKEN}"

enableGlobalCache: true

plugins:
  - path: .yarn/plugins/@yarnpkg/plugin-typescript.cjs
    spec: "@yarnpkg/plugin-typescript"
```

### Yarn Classic Configuration

```ini
# .yarnrc
registry "https://npm.mycompany.com/"
"@mycompany:registry" "https://npm.mycompany.com/"
```

### Environment Variables

| Variable | Purpose |
|----------|---------|
| `YARN_NPM_AUTH_TOKEN` | Registry authentication |
| `YARN_NPM_REGISTRY_SERVER` | Default registry URL |
| `YARN_ENABLE_GLOBAL_CACHE` | Enable global cache |

---

## SBOM Generation

### Using cdxgen

```bash
# Install cdxgen
npm install -g @cyclonedx/cdxgen

# Generate SBOM
cdxgen -o sbom.json

# Exclude dev dependencies
cdxgen --no-dev -o sbom.json

# Specify output format
cdxgen -o sbom.json --format json --spec-version 1.5
```

### Using CycloneDX Yarn Plugin

```bash
# Install globally
npm install -g @cyclonedx/yarn-plugin-cyclonedx

# For Yarn Berry, add plugin
yarn plugin import https://github.com/CycloneDX/cyclonedx-node-yarn/releases/latest/download/yarn-plugin-cyclonedx.cjs

# Generate SBOM
yarn cyclonedx --output-file sbom.json

# Exclude dev dependencies
yarn cyclonedx --production --output-file sbom.json
```

### Using cdxgen

```bash
# Generate from directory
cdxgen -o sbom.json

# Specify type
cdxgen -t js -o sbom.json
```

### Configuration Options

| Option | Description | Default |
|--------|-------------|---------|
| `--production` | Exclude devDependencies | Include all |
| `--output-format` | json or xml | json |
| `--spec-version` | CycloneDX version | Latest |

---

## Cache Locations

### Yarn Classic

| Platform | Path |
|----------|------|
| Linux/macOS | `~/.cache/yarn/` |
| Windows | `%LocalAppData%/Yarn/Cache/` |

### Yarn Berry

| Configuration | Path |
|---------------|------|
| Global Cache | `~/.yarn/berry/cache/` |
| Project Cache | `.yarn/cache/` |
| Zero-Installs | `.yarn/cache/` (committed) |

```bash
# Find cache location
yarn cache dir         # Classic
yarn config get cacheFolder  # Berry
```

---

## Best Practices Detection

Patterns to detect good dependency management practices in CI/CD, Makefiles, and scripts.

### yarn install --frozen-lockfile
**Pattern**: `yarn\s+install\s+--frozen-lockfile|yarn\s+--frozen-lockfile`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Ensures reproducible builds from lock file
- Fails if lock file needs updating

### yarn install --immutable
**Pattern**: `yarn\s+install\s+--immutable`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Yarn Berry equivalent of frozen-lockfile
- Strict lock file enforcement

### yarn audit
**Pattern**: `yarn\s+audit`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Vulnerability scanning
- Should run in CI/CD pipelines

### yarn dedupe
**Pattern**: `yarn\s+dedupe`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Deduplicating dependencies
- Reduces bundle size and potential conflicts

### yarn dlx
**Pattern**: `yarn\s+dlx`
**Type**: regex
**Severity**: info
**Context**: CI/CD, scripts
- Running packages without installing (Yarn Berry)
- npx equivalent for Yarn

### enableImmutableInstalls
**Pattern**: `enableImmutableInstalls:\s*true`
**Type**: regex
**Severity**: info
**Context**: .yarnrc.yml
- Yarn Berry strict mode
- Prevents unintended lock file changes

### checksumBehavior throw
**Pattern**: `checksumBehavior:\s*(throw|update)`
**Type**: regex
**Severity**: info
**Context**: .yarnrc.yml
- Strict checksum verification
- Supply chain integrity

---

## Anti-Patterns Detection

Patterns that indicate potential issues.

### yarn.lock in gitignore
**Pattern**: `yarn\.lock` in `.gitignore`
**Type**: regex
**Severity**: high
**Context**: .gitignore
- yarn.lock should be committed for reproducible builds

### HTTP registry
**Pattern**: `npmRegistryServer:\s*["']?http://`
**Type**: regex
**Severity**: high
**Context**: .yarnrc.yml, .yarnrc
- Using HTTP for registry URLs
- Vulnerable to MITM attacks

### Unsafe HTTP allowed
**Pattern**: `unsafeHttpWhitelist:`
**Type**: regex
**Severity**: high
**Context**: .yarnrc.yml
- Allowing HTTP connections
- Security risk for supply chain

### No integrity check
**Pattern**: `checksumBehavior:\s*ignore`
**Type**: regex
**Severity**: high
**Context**: .yarnrc.yml
- Disabling checksum verification
- Supply chain security risk

### Resolutions overrides
**Pattern**: `"resolutions":\s*\{`
**Type**: regex
**Severity**: low
**Context**: package.json
- Manual version overrides
- May hide dependency issues (note: can be legitimate)

---

## Best Practices Summary

1. **Always commit yarn.lock** for reproducible builds
2. **Use `yarn install --frozen-lockfile`** in CI/CD
3. **Consider Plug'n'Play** for faster installs (Berry)
4. **Use workspaces** for monorepo management
5. **Enable Zero-Installs** for instant CI builds
6. **Run `yarn audit`** before SBOM generation

### Yarn Berry Specific

```yaml
# .yarnrc.yml for reproducible builds
enableImmutableInstalls: true
checksumBehavior: throw
```

---

## Troubleshooting

### Missing Lock File
```bash
# Generate lock file
yarn install
```

### Lock File Out of Sync
```bash
# Classic
rm yarn.lock && yarn install

# Berry
yarn install --mode update-lockfile
```

### Migration from Classic to Berry
```bash
# Upgrade Yarn
yarn set version berry

# Migrate configuration
yarn install
```

### Private Packages
```yaml
# .yarnrc.yml
npmScopes:
  mycompany:
    npmRegistryServer: "https://npm.mycompany.com/"
    npmAuthToken: "${NPM_TOKEN}"
```

---

## Workspaces Support

Yarn workspaces affect SBOM generation:

```json
// package.json
{
  "workspaces": [
    "packages/*"
  ]
}
```

**SBOM Considerations**:
- Generate per-workspace or root-level
- Use `--workspace` flag to target specific packages
- Consider `nohoist` packages

---

## References

- [Yarn Documentation](https://yarnpkg.com/)
- [Yarn Lock File Format](https://yarnpkg.com/features/offline-cache)
- [CycloneDX Yarn Plugin](https://github.com/CycloneDX/cyclonedx-node-yarn)
- [Yarn Berry Migration](https://yarnpkg.com/migration/guide)
