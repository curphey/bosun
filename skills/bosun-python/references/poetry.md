# Poetry Package Manager

**Ecosystem**: Python
**Package Registry**: https://pypi.org
**Documentation**: https://python-poetry.org/docs/

---

## TIER 1: Manifest Detection

### Manifest Files

| File | Required | Description |
|------|----------|-------------|
| `pyproject.toml` | Yes | Primary manifest (PEP 518/621) |
| `poetry.toml` | No | Local Poetry configuration |

### pyproject.toml Detection

**Pattern**: `pyproject\.toml$`
**Confidence**: 90% (HIGH)

**Poetry-Specific Pattern**: `\[tool\.poetry\]`
**Confidence**: 98% (HIGH)

### Required Sections for SBOM

```toml
[tool.poetry]
name = "my-package"
version = "0.1.0"
description = "Package description"

[tool.poetry.dependencies]
python = "^3.9"
requests = "^2.31.0"

[tool.poetry.group.dev.dependencies]
pytest = "^7.4.0"
```

### Dependency Types

| Section | Included in SBOM | Notes |
|---------|------------------|-------|
| `[tool.poetry.dependencies]` | Yes (always) | Production |
| `[tool.poetry.group.dev.dependencies]` | Configurable | Development |
| `[tool.poetry.group.test.dependencies]` | Configurable | Testing |
| `[tool.poetry.extras]` | Configurable | Optional features |

---

## TIER 2: Lock File Detection

### Lock File

| File | Format | Version |
|------|--------|---------|
| `poetry.lock` | TOML | 1.1, 2.0 |

**Pattern**: `poetry\.lock$`
**Confidence**: 98% (HIGH)

### Lock File Structure

```toml
# This file is automatically @generated by Poetry and should not be changed.

[[package]]
name = "requests"
version = "2.31.0"
description = "Python HTTP for Humans."
optional = false
python-versions = ">=3.7"
files = [
    {file = "requests-2.31.0-py3-none-any.whl", hash = "sha256:58cd2..."},
    {file = "requests-2.31.0.tar.gz", hash = "sha256:942c5..."},
]

[package.dependencies]
certifi = ">=2017.4.17"
charset-normalizer = ">=2,<4"
idna = ">=2.5,<4"
urllib3 = ">=1.21.1,<3"

[package.extras]
socks = ["PySocks (>=1.5.6,!=1.5.7)"]

[metadata]
lock-version = "2.0"
python-versions = "^3.9"
content-hash = "abc123..."
```

### Key Lock File Fields

| Field | SBOM Use |
|-------|----------|
| `name` | Package identifier |
| `version` | Exact version |
| `files[].hash` | SHA-256 integrity |
| `dependencies` | Transitive dependencies |
| `optional` | Optional dependency flag |
| `python-versions` | Python version constraint |
| `extras` | Optional feature dependencies |

---

## TIER 3: Configuration Extraction

### Registry Configuration

**File**: `poetry.toml` or `pyproject.toml`

**Pattern**: `url\s*=\s*['"]([^'"]+)['"]`
**Context**: `[[tool.poetry.source]]`

### Common Configuration

```toml
# pyproject.toml
[[tool.poetry.source]]
name = "private"
url = "https://pypi.mycompany.com/simple/"
priority = "supplemental"

[[tool.poetry.source]]
name = "PyPI"
priority = "primary"
```

### Environment Variables

| Variable | Purpose |
|----------|---------|
| `POETRY_PYPI_TOKEN_PYPI` | PyPI authentication |
| `POETRY_HTTP_BASIC_*_USERNAME` | Private registry username |
| `POETRY_HTTP_BASIC_*_PASSWORD` | Private registry password |
| `POETRY_VIRTUALENVS_IN_PROJECT` | Create .venv in project |

---

## SBOM Generation

### Using cdxgen

```bash
# Install cdxgen
npm install -g @cyclonedx/cdxgen

# Generate SBOM from poetry.lock
cdxgen -o sbom.json

# Exclude dev dependencies
cdxgen --no-dev -o sbom.json

# Specify output format
cdxgen -o sbom.json --format json --spec-version 1.5
```

### Using cyclonedx-python

```bash
# Install in Poetry environment
poetry add --group dev cyclonedx-bom

# Generate SBOM
poetry run cyclonedx-py poetry -o sbom.json

# From lock file
poetry run cyclonedx-py poetry --from-poetry-lock -o sbom.json
```

### Using cdxgen

```bash
# Generate from directory
cdxgen -o sbom.json

# Specify type
cdxgen -t python -o sbom.json
```

### Configuration Options

| Option | Description | Default |
|--------|-------------|---------|
| `--without dev` | Exclude dev group | Include all |
| `--without test` | Exclude test group | Include |
| `--only main` | Only main dependencies | All groups |
| `--extras all` | Include all extras | None |

---

## Cache Locations

| Platform | Path |
|----------|------|
| Linux | `~/.cache/pypoetry/` |
| macOS | `~/Library/Caches/pypoetry/` |
| Windows | `%AppData%\pypoetry\Cache\` |

### Virtual Environment Locations

| Configuration | Path |
|---------------|------|
| Default | `{cache-dir}/virtualenvs/` |
| `virtualenvs.in-project = true` | `.venv/` |

```bash
# Find current environment
poetry env info --path
```

---

## Best Practices

1. **Always commit poetry.lock** for reproducible builds
2. **Use `poetry install --no-dev`** in production
3. **Use dependency groups** (`dev`, `test`) for organization
4. **Pin Python version** in `[tool.poetry.dependencies]`
5. **Specify hashes** by using lock file for SBOM generation
6. **Use `poetry lock --no-update`** to update lock file without upgrading

---

## Troubleshooting

### Missing Lock File
```bash
# Generate lock file
poetry lock
```

### Lock File Out of Sync
```bash
# Regenerate from scratch
rm poetry.lock
poetry lock
```

### Dependency Resolution Failures
```bash
# Clear cache
poetry cache clear pypi --all

# Update with verbose output
poetry lock -vvv
```

### Private Packages
```bash
# Add private source
poetry source add private https://pypi.mycompany.com/simple/

# Configure credentials
poetry config http-basic.private username password
```

---

## Best Practices Detection

### Poetry Lock File Present
**Pattern**: `poetry\.lock`
**Type**: regex
**Severity**: info
**Languages**: [toml]
**Context**: lock file
- Lock file ensures reproducible builds
- Recommended for all Poetry projects

### Poetry Python Version Pinned
**Pattern**: `\[tool\.poetry\.dependencies\][^[]*python\s*=\s*['\"][\^~]?[0-9]+\.[0-9]+`
**Type**: regex
**Severity**: info
**Languages**: [toml]
**Context**: pyproject.toml
- Python version specified in dependencies
- Best practice for reproducibility

### Poetry Group Dependencies
**Pattern**: `\[tool\.poetry\.group\.\w+\.dependencies\]`
**Type**: regex
**Severity**: info
**Languages**: [toml]
**Context**: pyproject.toml
- Using Poetry groups for organization
- Separates dev/test dependencies properly

---

## Anti-Patterns Detection

### Missing Poetry Lock File
**Pattern**: `\[tool\.poetry\](?![\s\S]*poetry\.lock)`
**Type**: regex
**Severity**: medium
**Languages**: [toml]
**Context**: pyproject.toml
- pyproject.toml without accompanying lock file
- CWE-829: Inclusion of Functionality from Untrusted Source

### Unpinned Dependency (Wildcard)
**Pattern**: `['\"][a-zA-Z][a-zA-Z0-9_-]*['\"]s*=\s*['\"][*]['\"]`
**Type**: regex
**Severity**: high
**Languages**: [toml]
**Context**: pyproject.toml
- Wildcard version allows any version
- CWE-829: Dependency version not pinned

### Git Dependency Without Tag
**Pattern**: `git\s*=\s*['\"][^'\"]+['\"](?!.*tag|rev)`
**Type**: regex
**Severity**: medium
**Languages**: [toml]
**Context**: pyproject.toml
- Git dependency without tag or revision
- CWE-829: Unpinned git dependency

### Private Registry Without HTTPS
**Pattern**: `url\s*=\s*['\"]http://(?!localhost)`
**Type**: regex
**Severity**: high
**Languages**: [toml]
**Context**: pyproject.toml
- Non-HTTPS registry URL
- CWE-319: Cleartext Transmission

---

## References

- [Poetry Documentation](https://python-poetry.org/docs/)
- [pyproject.toml Specification](https://packaging.python.org/en/latest/guides/writing-pyproject-toml/)
- [PEP 621 - Project Metadata](https://peps.python.org/pep-0621/)
- [CycloneDX Python](https://github.com/CycloneDX/cyclonedx-python)
