<!--
Copyright (c) 2025 Crash Override Inc. - https://crashoverride.com

SPDX-License-Identifier: GPL-3.0
-->

# Configuration Security Patterns

## Debug Mode in Production (CWE-489)

### Description
Debug features enabled in production can expose sensitive information, provide attack vectors, and degrade performance.

### Dangerous Patterns

**Python/Django**
```python
# VULNERABLE - settings.py
DEBUG = True  # Never in production
TEMPLATE_DEBUG = True

# VULNERABLE - Flask
app = Flask(__name__)
app.debug = True
app.run(debug=True)

# VULNERABLE - environment variable default
DEBUG = os.environ.get('DEBUG', True)  # Dangerous default
```

**JavaScript/Node.js**
```javascript
// VULNERABLE - Express
app.use(errorhandler());  // Exposes stack traces

// VULNERABLE - environment check missing
if (true) {  // Should check NODE_ENV
  app.use(morgan('dev'));
}

// VULNERABLE - debug module always on
const debug = require('debug')('app');
debug.enabled = true;
```

**Java**
```java
// VULNERABLE - Spring Boot
# application.properties
spring.devtools.restart.enabled=true
spring.h2.console.enabled=true
management.endpoints.web.exposure.include=*

// VULNERABLE - Struts
<constant name="struts.devMode" value="true"/>
```

### Safe Patterns

```python
# SECURE - Django
DEBUG = os.environ.get('DEBUG', 'False').lower() == 'true'
# Or use django-environ with explicit production settings

# SECURE - Flask
app.debug = os.environ.get('FLASK_DEBUG', 'False').lower() == 'true'
```

```javascript
// SECURE - Node.js
if (process.env.NODE_ENV !== 'production') {
  app.use(morgan('dev'));
}

// SECURE - error handler
app.use((err, req, res, next) => {
  console.error(err.stack);  // Log internally
  res.status(500).json({ error: 'Internal Server Error' });  // Generic response
});
```

---

## CORS Misconfiguration (CWE-942)

### Description
Overly permissive CORS settings can allow unauthorized websites to make authenticated requests to your API.

### Dangerous Patterns

```python
# VULNERABLE - Flask-CORS
from flask_cors import CORS
CORS(app, origins="*", supports_credentials=True)  # Wildcard + credentials

# VULNERABLE - Django
CORS_ALLOW_ALL_ORIGINS = True
CORS_ALLOW_CREDENTIALS = True  # Dangerous combination

# VULNERABLE - reflecting Origin
@app.after_request
def add_cors(response):
    origin = request.headers.get('Origin')
    response.headers['Access-Control-Allow-Origin'] = origin  # Reflects any origin
    response.headers['Access-Control-Allow-Credentials'] = 'true'
    return response
```

```javascript
// VULNERABLE - Express
app.use(cors({
  origin: true,  // Reflects request origin
  credentials: true
}));

// VULNERABLE - manual header
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Credentials', 'true');  // Invalid with *
  next();
});

// VULNERABLE - regex bypass
const allowedOrigins = /example\.com$/;  // Matches evil-example.com
```

```java
// VULNERABLE - Spring
@CrossOrigin(origins = "*", allowCredentials = "true")

// VULNERABLE - CorsConfiguration
CorsConfiguration config = new CorsConfiguration();
config.addAllowedOrigin("*");
config.setAllowCredentials(true);
```

### Safe Patterns

```python
# SECURE - explicit allowlist
CORS_ALLOWED_ORIGINS = [
    'https://app.example.com',
    'https://admin.example.com',
]
CORS_ALLOW_CREDENTIALS = True  # Safe with explicit origins
```

```javascript
// SECURE - explicit allowlist
const allowedOrigins = ['https://app.example.com', 'https://admin.example.com'];

app.use(cors({
  origin: (origin, callback) => {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true
}));
```

---

## Insecure Cookie Configuration (CWE-614)

### Dangerous Patterns

```python
# VULNERABLE - Flask
response.set_cookie('session', token)  # Missing flags

# VULNERABLE - Django settings
SESSION_COOKIE_SECURE = False
SESSION_COOKIE_HTTPONLY = False
CSRF_COOKIE_SECURE = False
```

```javascript
// VULNERABLE - Express
res.cookie('session', token);  // No security flags

res.cookie('session', token, {
  httpOnly: false,  // Accessible to JavaScript (XSS risk)
  secure: false,    // Sent over HTTP
  sameSite: 'none'  // Cross-site requests allowed
});
```

```java
// VULNERABLE - Java Servlet
Cookie cookie = new Cookie("session", token);
response.addCookie(cookie);  // No flags set
```

### Safe Patterns

```python
# SECURE - Flask
response.set_cookie(
    'session',
    token,
    httponly=True,
    secure=True,
    samesite='Strict'
)

# SECURE - Django settings
SESSION_COOKIE_SECURE = True
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Strict'
CSRF_COOKIE_SECURE = True
CSRF_COOKIE_HTTPONLY = True
```

```javascript
// SECURE - Express
res.cookie('session', token, {
  httpOnly: true,   // Not accessible to JavaScript
  secure: true,     // Only sent over HTTPS
  sameSite: 'strict', // No cross-site requests
  maxAge: 3600000   // 1 hour expiry
});
```

---

## Missing Security Headers (CWE-16)

### Required Headers

| Header | Purpose | Recommended Value |
|--------|---------|-------------------|
| `Content-Security-Policy` | Prevent XSS, data injection | `default-src 'self'` |
| `Strict-Transport-Security` | Enforce HTTPS | `max-age=31536000; includeSubDomains` |
| `X-Content-Type-Options` | Prevent MIME sniffing | `nosniff` |
| `X-Frame-Options` | Prevent clickjacking | `DENY` or `SAMEORIGIN` |
| `X-XSS-Protection` | Legacy XSS filter | `1; mode=block` |
| `Referrer-Policy` | Control referrer info | `strict-origin-when-cross-origin` |
| `Permissions-Policy` | Control browser features | Feature-specific |

### Implementation

```python
# Flask with flask-talisman
from flask_talisman import Talisman
Talisman(app, content_security_policy={
    'default-src': "'self'",
    'script-src': "'self'",
    'style-src': "'self'"
})

# Django settings
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'
SECURE_BROWSER_XSS_FILTER = True
```

```javascript
// Express with helmet
const helmet = require('helmet');
app.use(helmet());

// Or manually
app.use((req, res, next) => {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  res.setHeader('Content-Security-Policy', "default-src 'self'");
  next();
});
```

---

## Insecure Default Configurations

### Database Defaults

```yaml
# VULNERABLE - MongoDB without auth
mongod --bind_ip 0.0.0.0  # Exposed to network, no auth

# VULNERABLE - Redis without auth
bind 0.0.0.0
protected-mode no

# VULNERABLE - Elasticsearch
network.host: 0.0.0.0
xpack.security.enabled: false
```

### Container/Infrastructure

```dockerfile
# VULNERABLE - running as root
FROM node:18
# No USER directive = runs as root

# SECURE
FROM node:18
RUN useradd -m appuser
USER appuser
```

```yaml
# VULNERABLE - Kubernetes
securityContext:
  privileged: true
  runAsUser: 0

# SECURE
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
```

### Terraform/IaC

```hcl
# VULNERABLE - S3 bucket
resource "aws_s3_bucket" "data" {
  bucket = "my-bucket"
  acl    = "public-read"  # Public access
}

# VULNERABLE - Security group
resource "aws_security_group" "web" {
  ingress {
    from_port   = 0
    to_port     = 65535
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]  # All ports open to internet
  }
}

# SECURE
resource "aws_s3_bucket_public_access_block" "data" {
  bucket = aws_s3_bucket.data.id
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
```

---

## XXE in XML Parsers (CWE-611)

### Dangerous Patterns

```python
# VULNERABLE - lxml
from lxml import etree
doc = etree.parse(user_file)  # XXE enabled by default

# VULNERABLE - xml.etree (Python < 3.7.1)
import xml.etree.ElementTree as ET
tree = ET.parse(user_file)
```

```java
// VULNERABLE - DocumentBuilder
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
DocumentBuilder db = dbf.newDocumentBuilder();
Document doc = db.parse(userInputStream);  // XXE enabled

// VULNERABLE - SAXParser
SAXParserFactory spf = SAXParserFactory.newInstance();
SAXParser parser = spf.newSAXParser();
parser.parse(userFile, handler);
```

### Safe Patterns

```python
# SECURE - defusedxml
from defusedxml import ElementTree
tree = ElementTree.parse(user_file)

# SECURE - lxml with disabled features
from lxml import etree
parser = etree.XMLParser(
    resolve_entities=False,
    no_network=True,
    dtd_validation=False,
    load_dtd=False
)
doc = etree.parse(user_file, parser)
```

```java
// SECURE - disable external entities
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
dbf.setFeature("http://xml.org/sax/features/external-general-entities", false);
dbf.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
dbf.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd", false);
dbf.setXIncludeAware(false);
dbf.setExpandEntityReferences(false);
```

---

## Detection Checklist

### Configuration Files to Review
- `settings.py`, `config.py` (Django/Flask)
- `application.properties`, `application.yml` (Spring)
- `.env`, `config.json`, `config.yaml`
- `Dockerfile`, `docker-compose.yml`
- `*.tf`, `*.tfvars` (Terraform)
- `serverless.yml`, `template.yaml` (AWS SAM)
- `nginx.conf`, `apache.conf`

### Patterns to Flag
- `DEBUG = True`, `debug: true`
- `CORS.*origin.*\*` with credentials
- Missing `Secure`, `HttpOnly`, `SameSite` on cookies
- `0.0.0.0` bind addresses
- `acl.*public`, `public-read`
- Missing security headers middleware
- XML parsers without entity restrictions

---

## Detection Patterns

### Debug Mode in Production

#### Django DEBUG True
**Pattern**: `DEBUG\s*=\s*True`
**Type**: regex
**Severity**: high
**Languages**: [python]
- Django DEBUG mode enabled
- CWE-489: Debug Code in Production

#### Flask Debug Mode
**Pattern**: `(app\.debug\s*=\s*True|\.run\s*\([^)]*debug\s*=\s*True)`
**Type**: regex
**Severity**: high
**Languages**: [python]
- Flask debug mode enabled
- CWE-489: Debug Code in Production

#### Node.js errorhandler
**Pattern**: `app\.use\s*\(\s*errorhandler\s*\(\s*\)\s*\)`
**Type**: regex
**Severity**: medium
**Languages**: [javascript, typescript]
- Error handler exposing stack traces
- CWE-489: Debug Code in Production

### CORS Misconfiguration

#### CORS Wildcard with Credentials
**Pattern**: `origin\s*[=:]\s*['\"]?\*['\"]?.*credentials\s*[=:]\s*true`
**Type**: regex
**Severity**: high
**Languages**: [python, javascript, typescript]
- CORS wildcard with credentials
- CWE-942: Overly Permissive CORS

#### CORS Origin Reflection
**Pattern**: `Access-Control-Allow-Origin.*request\.headers.*Origin`
**Type**: regex
**Severity**: high
**Languages**: [python, javascript, typescript]
- CORS reflecting request origin
- CWE-942: Overly Permissive CORS

#### Django CORS All Origins
**Pattern**: `CORS_ALLOW_ALL_ORIGINS\s*=\s*True`
**Type**: regex
**Severity**: high
**Languages**: [python]
- Django CORS allowing all origins
- CWE-942: Overly Permissive CORS

### Insecure Cookies

#### Cookie Missing Secure Flag
**Pattern**: `set_cookie\s*\([^)]*\)(?!.*secure\s*=\s*True)`
**Type**: regex
**Severity**: medium
**Languages**: [python]
- Cookie without Secure flag
- CWE-614: Insecure Cookie

#### Cookie Missing HttpOnly
**Pattern**: `\.cookie\s*\([^)]*httpOnly\s*:\s*false`
**Type**: regex
**Severity**: medium
**Languages**: [javascript, typescript]
- Cookie with httpOnly disabled
- CWE-1004: Sensitive Cookie Without HttpOnly

#### Cookie Missing SameSite
**Pattern**: `\.cookie\s*\([^)]*sameSite\s*:\s*['\"]none['\"]`
**Type**: regex
**Severity**: medium
**Languages**: [javascript, typescript]
- Cookie with SameSite=none
- CWE-1275: Sensitive Cookie Without SameSite

### Insecure Defaults

#### Bind to All Interfaces
**Pattern**: `(bind|host)\s*[=:]\s*['\"]0\.0\.0\.0['\"]`
**Type**: regex
**Severity**: medium
**Languages**: [python, javascript, typescript, yaml]
- Binding to all network interfaces
- CWE-200: Information Exposure

#### MongoDB No Auth
**Pattern**: `mongodb://(localhost|127\.0\.0\.1|0\.0\.0\.0)(?!.*authSource)`
**Type**: regex
**Severity**: high
**Languages**: [python, javascript, typescript, yaml]
- MongoDB without authentication
- CWE-306: Missing Authentication

#### Redis No Auth
**Pattern**: `redis://(localhost|127\.0\.0\.1|0\.0\.0\.0)(?!.*password)`
**Type**: regex
**Severity**: high
**Languages**: [python, javascript, typescript, yaml]
- Redis without password
- CWE-306: Missing Authentication

### S3 Public Access

#### S3 Public ACL
**Pattern**: `(acl|ACL)\s*[=:]\s*['\"]public-(read|read-write)['\"]`
**Type**: regex
**Severity**: critical
**Languages**: [terraform, yaml, python, javascript]
- S3 bucket with public ACL
- CWE-732: Insecure Permission

### XXE Vulnerabilities

#### lxml Without Protection
**Pattern**: `etree\.parse\s*\([^)]*\)(?!.*XMLParser)`
**Type**: regex
**Severity**: high
**Languages**: [python]
- lxml parse without safe parser
- CWE-611: XXE

#### Java XML Without Feature Disable
**Pattern**: `DocumentBuilderFactory\.newInstance\s*\(\)(?!.*setFeature)`
**Type**: regex
**Severity**: high
**Languages**: [java]
- XML parser without XXE protection
- CWE-611: XXE

### Container Security

#### Docker Run as Root
**Pattern**: `^FROM.*\n(?!.*USER\s+\w+)`
**Type**: regex
**Severity**: medium
**Languages**: [dockerfile]
- Dockerfile without USER directive
- CWE-250: Execution with Unnecessary Privileges

#### Kubernetes Privileged Container
**Pattern**: `privileged\s*:\s*true`
**Type**: regex
**Severity**: critical
**Languages**: [yaml]
- Kubernetes privileged container
- CWE-250: Execution with Unnecessary Privileges

#### Kubernetes RunAsRoot
**Pattern**: `runAsUser\s*:\s*0`
**Type**: regex
**Severity**: high
**Languages**: [yaml]
- Kubernetes running as root
- CWE-250: Execution with Unnecessary Privileges
