<!--
Copyright (c) 2025 Crash Override Inc. - https://crashoverride.com

SPDX-License-Identifier: GPL-3.0
-->

# Deserialization Vulnerability Patterns

## Insecure Deserialization (CWE-502)

### Description
Deserialization of untrusted data can lead to remote code execution when the serialization format allows for object instantiation or method invocation.

### Python - Pickle (CRITICAL)

**Dangerous Patterns**
```python
# VULNERABLE - RCE via malicious pickle
import pickle

data = request.get_data()
obj = pickle.loads(data)  # Attacker controls data

# VULNERABLE - loading from untrusted file
with open(user_provided_path, 'rb') as f:
    obj = pickle.load(f)

# VULNERABLE - yaml.load with untrusted data
import yaml
config = yaml.load(user_input)  # yaml.load is dangerous by default

# VULNERABLE - marshal module
import marshal
code = marshal.loads(user_data)
```

**Safe Patterns**
```python
# SECURE - use JSON for untrusted data
import json
obj = json.loads(data)

# SECURE - yaml safe_load
import yaml
config = yaml.safe_load(user_input)

# SECURE - restrict unpickler (if pickle required)
import pickle
import io

class RestrictedUnpickler(pickle.Unpickler):
    def find_class(self, module, name):
        # Only allow safe classes
        if module == "builtins" and name in ("dict", "list", "str", "int"):
            return getattr(__import__(module), name)
        raise pickle.UnpicklingError(f"Forbidden: {module}.{name}")

def safe_loads(data):
    return RestrictedUnpickler(io.BytesIO(data)).load()
```

### Java - ObjectInputStream (CRITICAL)

**Dangerous Patterns**
```java
// VULNERABLE - deserializing untrusted data
ObjectInputStream ois = new ObjectInputStream(request.getInputStream());
Object obj = ois.readObject();  // RCE if attacker controls stream

// VULNERABLE - deserializing from file
FileInputStream fis = new FileInputStream(userProvidedPath);
ObjectInputStream ois = new ObjectInputStream(fis);
Object obj = ois.readObject();

// VULNERABLE - XMLDecoder
XMLDecoder decoder = new XMLDecoder(request.getInputStream());
Object obj = decoder.readObject();  // RCE
```

**Safe Patterns**
```java
// SECURE - use JSON
ObjectMapper mapper = new ObjectMapper();
MyClass obj = mapper.readValue(jsonString, MyClass.class);

// SECURE - ValidatingObjectInputStream (Apache Commons IO)
ValidatingObjectInputStream vois = new ValidatingObjectInputStream(inputStream);
vois.accept(SafeClass.class);  // Whitelist allowed classes
Object obj = vois.readObject();

// SECURE - Look-ahead deserialization filter (Java 9+)
ObjectInputFilter filter = ObjectInputFilter.Config.createFilter(
    "com.myapp.*;!*"  // Allow only com.myapp classes
);
ois.setObjectInputFilter(filter);
```

### PHP - unserialize (CRITICAL)

**Dangerous Patterns**
```php
// VULNERABLE - unserialize with user data
$data = $_GET['data'];
$obj = unserialize($data);  // Object injection, potential RCE

// VULNERABLE - even with base64
$obj = unserialize(base64_decode($_COOKIE['session']));
```

**Safe Patterns**
```php
// SECURE - use JSON
$obj = json_decode($data);

// SECURE - restrict allowed classes (PHP 7+)
$obj = unserialize($data, ['allowed_classes' => ['SafeClass']]);

// SECURE - no object instantiation
$obj = unserialize($data, ['allowed_classes' => false]);
```

### Ruby - Marshal (HIGH)

**Dangerous Patterns**
```ruby
# VULNERABLE - Marshal.load with untrusted data
data = params[:data]
obj = Marshal.load(data)  # RCE

# VULNERABLE - YAML.load (Ruby < 3.1)
config = YAML.load(user_input)  # Object instantiation
```

**Safe Patterns**
```ruby
# SECURE - use JSON
obj = JSON.parse(data)

# SECURE - YAML.safe_load
config = YAML.safe_load(user_input, permitted_classes: [])

# SECURE - explicitly specify allowed classes
config = YAML.safe_load(user_input, permitted_classes: [Date, Time])
```

### Node.js - node-serialize (CRITICAL)

**Dangerous Patterns**
```javascript
// VULNERABLE - node-serialize with IIFE
const serialize = require('node-serialize');
const obj = serialize.unserialize(userInput);  // RCE via IIFE

// VULNERABLE - js-yaml type coercion
const yaml = require('js-yaml');
const config = yaml.load(userInput);  // Type coercion attacks
```

**Safe Patterns**
```javascript
// SECURE - use JSON
const obj = JSON.parse(data);

// SECURE - js-yaml with safe schema
const yaml = require('js-yaml');
const config = yaml.load(userInput, { schema: yaml.FAILSAFE_SCHEMA });

// SECURE - avoid node-serialize entirely
// Use JSON or a safer serialization library
```

### .NET - BinaryFormatter (CRITICAL)

**Dangerous Patterns**
```csharp
// VULNERABLE - BinaryFormatter
BinaryFormatter bf = new BinaryFormatter();
object obj = bf.Deserialize(stream);  // RCE

// VULNERABLE - NetDataContractSerializer
var serializer = new NetDataContractSerializer();
object obj = serializer.ReadObject(stream);

// VULNERABLE - SoapFormatter
SoapFormatter sf = new SoapFormatter();
object obj = sf.Deserialize(stream);

// VULNERABLE - LosFormatter
LosFormatter lf = new LosFormatter();
object obj = lf.Deserialize(base64String);

// VULNERABLE - ObjectStateFormatter
ObjectStateFormatter osf = new ObjectStateFormatter();
object obj = osf.Deserialize(data);
```

**Safe Patterns**
```csharp
// SECURE - use JSON
var obj = JsonSerializer.Deserialize<MyClass>(jsonString);

// SECURE - DataContractSerializer with known types
var serializer = new DataContractSerializer(typeof(MyClass));
var obj = serializer.ReadObject(stream);

// SECURE - XmlSerializer (type must be known at compile time)
var serializer = new XmlSerializer(typeof(MyClass));
var obj = serializer.Deserialize(stream);
```

---

## Detection Indicators

### High-Risk Functions by Language

| Language | Dangerous Functions | CWE |
|----------|---------------------|-----|
| Python | `pickle.loads()`, `pickle.load()`, `yaml.load()`, `marshal.loads()` | CWE-502 |
| Java | `ObjectInputStream.readObject()`, `XMLDecoder.readObject()` | CWE-502 |
| PHP | `unserialize()` | CWE-502 |
| Ruby | `Marshal.load()`, `YAML.load()` | CWE-502 |
| Node.js | `node-serialize.unserialize()` | CWE-502 |
| .NET | `BinaryFormatter.Deserialize()`, `NetDataContractSerializer` | CWE-502 |

### Code Patterns to Flag
- Deserialization of HTTP request body
- Deserialization of cookies or headers
- Deserialization of file contents from user-controlled paths
- Deserialization of database content
- Deserialization of message queue payloads

### Exploit Chains
- **Python pickle**: `__reduce__` method allows arbitrary code execution
- **Java**: Gadget chains (Commons Collections, Spring, etc.)
- **PHP**: Magic methods (`__wakeup`, `__destruct`) trigger code
- **Ruby**: ERB template injection via YAML
- **.NET**: TypeConfuseDelegate, ActivitySurrogateSelector

---

## Detection Patterns

### Python Deserialization

#### Pickle loads
**Pattern**: `pickle\.(loads|load)\s*\(`
**Type**: regex
**Severity**: critical
**Languages**: [python]
- pickle deserialization (RCE risk)
- CWE-502: Insecure Deserialization

#### YAML load (unsafe)
**Pattern**: `yaml\.load\s*\([^)]*\)(?!.*Loader\s*=\s*yaml\.SafeLoader)`
**Type**: regex
**Severity**: critical
**Languages**: [python]
- yaml.load without SafeLoader
- CWE-502: Insecure Deserialization

#### Marshal loads
**Pattern**: `marshal\.(loads|load)\s*\(`
**Type**: regex
**Severity**: critical
**Languages**: [python]
- marshal deserialization
- CWE-502: Insecure Deserialization

### Java Deserialization

#### ObjectInputStream readObject
**Pattern**: `ObjectInputStream.*\.readObject\s*\(\)`
**Type**: regex
**Severity**: critical
**Languages**: [java]
- Java ObjectInputStream deserialization
- CWE-502: Insecure Deserialization

#### XMLDecoder
**Pattern**: `XMLDecoder.*\.readObject\s*\(\)`
**Type**: regex
**Severity**: critical
**Languages**: [java]
- XMLDecoder deserialization (RCE)
- CWE-502: Insecure Deserialization

### PHP Deserialization

#### PHP unserialize
**Pattern**: `unserialize\s*\(\s*\$_(GET|POST|REQUEST|COOKIE)`
**Type**: regex
**Severity**: critical
**Languages**: [php]
- unserialize with user input
- CWE-502: Insecure Deserialization

#### PHP unserialize without allowed_classes
**Pattern**: `unserialize\s*\([^)]+\)(?!.*allowed_classes)`
**Type**: regex
**Severity**: high
**Languages**: [php]
- unserialize without class restriction
- CWE-502: Insecure Deserialization

### Ruby Deserialization

#### Marshal.load
**Pattern**: `Marshal\.load\s*\(`
**Type**: regex
**Severity**: critical
**Languages**: [ruby]
- Ruby Marshal deserialization
- CWE-502: Insecure Deserialization

#### Ruby YAML.load
**Pattern**: `YAML\.load\s*\([^)]*\)(?!.*permitted_classes)`
**Type**: regex
**Severity**: critical
**Languages**: [ruby]
- Ruby YAML.load (object instantiation)
- CWE-502: Insecure Deserialization

### Node.js Deserialization

#### node-serialize
**Pattern**: `(node-serialize|serialize)\.unserialize\s*\(`
**Type**: regex
**Severity**: critical
**Languages**: [javascript, typescript]
- node-serialize deserialization (RCE via IIFE)
- CWE-502: Insecure Deserialization

#### js-yaml unsafe
**Pattern**: `yaml\.load\s*\([^)]*\)(?!.*schema.*FAILSAFE)`
**Type**: regex
**Severity**: high
**Languages**: [javascript, typescript]
- js-yaml without safe schema
- CWE-502: Insecure Deserialization

### .NET Deserialization

#### BinaryFormatter
**Pattern**: `BinaryFormatter.*\.Deserialize\s*\(`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- BinaryFormatter deserialization (RCE)
- CWE-502: Insecure Deserialization

#### NetDataContractSerializer
**Pattern**: `NetDataContractSerializer.*\.(ReadObject|Deserialize)\s*\(`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- NetDataContractSerializer (RCE)
- CWE-502: Insecure Deserialization

#### LosFormatter
**Pattern**: `LosFormatter.*\.Deserialize\s*\(`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- LosFormatter deserialization
- CWE-502: Insecure Deserialization
