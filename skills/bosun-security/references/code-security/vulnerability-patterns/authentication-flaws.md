<!--
Copyright (c) 2025 Crash Override Inc. - https://crashoverride.com

SPDX-License-Identifier: GPL-3.0
-->

# Authentication & Authorization Vulnerability Patterns

## Hardcoded Credentials (CWE-798)

### Description
Hardcoded credentials in source code can be extracted by attackers who gain access to the codebase.

### Dangerous Patterns

**Hardcoded Passwords**
```python
# VULNERABLE
DB_PASSWORD = "secret123"
API_KEY = "sk-1234567890abcdef"

def connect():
    return mysql.connect(password="admin123")
```

```javascript
// VULNERABLE
const config = {
  password: 'mysecretpassword',
  apiKey: 'sk_live_xxxxxxxxxxxx'
};
```

```java
// VULNERABLE
private static final String DB_PASSWORD = "password123";
private static final String API_KEY = "AKIAIOSFODNN7EXAMPLE";
```

**Hardcoded Tokens**
```python
# VULNERABLE
GITHUB_TOKEN = "ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
SLACK_TOKEN = "xoxb-xxxxxxxxxxxx-xxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxx"
```

### Safe Patterns

**Environment Variables**
```python
# SECURE
import os
DB_PASSWORD = os.environ.get("DB_PASSWORD")
if not DB_PASSWORD:
    raise ValueError("DB_PASSWORD not set")
```

```javascript
// SECURE
const config = {
  password: process.env.DB_PASSWORD,
  apiKey: process.env.API_KEY
};
```

**Secrets Manager**
```python
# SECURE
import boto3
client = boto3.client('secretsmanager')
secret = client.get_secret_value(SecretId='prod/db/password')
```

### Detection Patterns

#### Hardcoded Password Variable
**Pattern**: `(password|passwd|pwd)\s*[=:]\s*['\"][^'\"]{4,}['\"]`
**Type**: regex
**Severity**: critical
**Languages**: [python, javascript, typescript, java, go]
- Hardcoded password in variable
- CWE-798: Hardcoded Credentials

#### Hardcoded API Key
**Pattern**: `(api_key|apikey|api-key|API_KEY)\s*[=:]\s*['\"][^'\"]{8,}['\"]`
**Type**: regex
**Severity**: critical
**Languages**: [python, javascript, typescript, java, go]
- Hardcoded API key
- CWE-798: Hardcoded Credentials

#### Hardcoded Secret Key
**Pattern**: `(secret_key|SECRET_KEY|secretKey)\s*[=:]\s*['\"][^'\"]{8,}['\"]`
**Type**: regex
**Severity**: critical
**Languages**: [python, javascript, typescript, java, go]
- Hardcoded secret key
- CWE-798: Hardcoded Credentials

#### AWS Access Key
**Pattern**: `AKIA[0-9A-Z]{16}`
**Type**: regex
**Severity**: critical
**Languages**: [python, javascript, typescript, java, go]
- AWS access key ID
- CWE-798: Hardcoded Credentials

#### GitHub Token
**Pattern**: `ghp_[a-zA-Z0-9]{36}`
**Type**: regex
**Severity**: critical
**Languages**: [python, javascript, typescript, java, go]
- GitHub personal access token
- CWE-798: Hardcoded Credentials

---

## Broken Authentication (CWE-306)

### Description
Missing or inadequate authentication allows unauthorized access to protected resources.

### Dangerous Patterns

**Missing Authentication**
```python
# VULNERABLE - no authentication check
@app.route('/admin/users')
def list_users():
    return jsonify(User.query.all())
```

```javascript
// VULNERABLE - endpoint without auth middleware
app.get('/api/admin/data', (req, res) => {
  res.json(sensitiveData);
});
```

**Weak Password Validation**
```python
# VULNERABLE - no password requirements
def register(username, password):
    if len(password) > 0:  # Too weak
        create_user(username, password)
```

### Safe Patterns

**Proper Authentication**
```python
# SECURE
@app.route('/admin/users')
@login_required
@admin_required
def list_users():
    return jsonify(User.query.all())
```

```javascript
// SECURE
app.get('/api/admin/data', authenticateToken, requireAdmin, (req, res) => {
  res.json(sensitiveData);
});
```

**Strong Password Policy**
```python
# SECURE
import re
def validate_password(password):
    if len(password) < 12:
        raise ValueError("Password must be at least 12 characters")
    if not re.search(r'[A-Z]', password):
        raise ValueError("Password must contain uppercase")
    if not re.search(r'[a-z]', password):
        raise ValueError("Password must contain lowercase")
    if not re.search(r'\d', password):
        raise ValueError("Password must contain digit")
    if not re.search(r'[!@#$%^&*]', password):
        raise ValueError("Password must contain special character")
```

---

## Broken Access Control (CWE-284)

### Description
Improper access control allows users to access resources or perform actions they shouldn't be authorized for.

### Dangerous Patterns

**Insecure Direct Object Reference (IDOR)**
```python
# VULNERABLE - no ownership check
@app.route('/api/documents/<doc_id>')
def get_document(doc_id):
    return Document.query.get(doc_id)
```

```javascript
// VULNERABLE - user can access any account
app.get('/api/account/:id', (req, res) => {
  const account = await Account.findById(req.params.id);
  res.json(account);
});
```

**Missing Authorization Check**
```python
# VULNERABLE - authenticated but not authorized
@app.route('/api/users/<user_id>/delete', methods=['POST'])
@login_required
def delete_user(user_id):
    User.query.get(user_id).delete()  # No admin check
```

### Safe Patterns

**Proper Authorization**
```python
# SECURE - ownership verification
@app.route('/api/documents/<doc_id>')
@login_required
def get_document(doc_id):
    doc = Document.query.get(doc_id)
    if doc.owner_id != current_user.id:
        abort(403)
    return doc
```

```javascript
// SECURE - verify ownership
app.get('/api/account/:id', authenticateToken, async (req, res) => {
  if (req.params.id !== req.user.accountId && !req.user.isAdmin) {
    return res.status(403).json({ error: 'Forbidden' });
  }
  const account = await Account.findById(req.params.id);
  res.json(account);
});
```

**Role-Based Access Control**
```python
# SECURE
@app.route('/api/users/<user_id>/delete', methods=['POST'])
@login_required
@admin_required  # Decorator checks role
def delete_user(user_id):
    User.query.get(user_id).delete()
```

---

## Session Management Issues (CWE-384)

### Dangerous Patterns

**Session Fixation**
```python
# VULNERABLE - not regenerating session after login
@app.route('/login', methods=['POST'])
def login():
    if check_credentials(request.form):
        session['user'] = request.form['username']
        # Session ID not regenerated!
```

**Insecure Session Storage**
```javascript
// VULNERABLE - storing session in localStorage
localStorage.setItem('authToken', token);
// Can be accessed by XSS
```

### Safe Patterns

**Session Regeneration**
```python
# SECURE
from flask import session
@app.route('/login', methods=['POST'])
def login():
    if check_credentials(request.form):
        session.clear()  # Clear old session
        session.regenerate()  # New session ID
        session['user'] = request.form['username']
```

**Secure Cookie Storage**
```javascript
// SECURE - use httpOnly cookies
res.cookie('authToken', token, {
  httpOnly: true,
  secure: true,
  sameSite: 'strict'
});
```

---

## Privilege Escalation (CWE-269)

### Dangerous Patterns

```python
# VULNERABLE - role stored client-side
@app.route('/api/action')
def do_action():
    role = request.headers.get('X-User-Role')  # Trust client header!
    if role == 'admin':
        perform_admin_action()
```

### Safe Patterns

```python
# SECURE - role from server-side session
@app.route('/api/action')
@login_required
def do_action():
    user = User.query.get(current_user.id)
    if user.role == 'admin':  # From database
        perform_admin_action()
```

---

## Detection Patterns Summary

### Missing Authentication Patterns

#### Flask Route Without Auth
**Pattern**: `@app\.route\s*\([^)]+\)\s*\ndef\s+\w+\s*\([^)]*\):(?!.*login_required|auth_required)`
**Type**: regex
**Severity**: high
**Languages**: [python]
- Flask route without authentication decorator
- CWE-306: Missing Authentication

#### Express Route Without Auth Middleware
**Pattern**: `app\.(get|post|put|delete)\s*\([^,]+,\s*\(req,\s*res`
**Type**: regex
**Severity**: medium
**Languages**: [javascript, typescript]
- Express route potentially missing auth middleware
- CWE-306: Missing Authentication

### IDOR/BOLA Patterns

#### Direct Object Reference from Params
**Pattern**: `\.(get|findById|findOne|findByPk)\s*\(\s*(req\.params|request\.args|params\[)`
**Type**: regex
**Severity**: high
**Languages**: [python, javascript, typescript]
- Direct object lookup from request parameters
- CWE-639: IDOR / BOLA

#### User ID from Request Without Check
**Pattern**: `(user_id|userId)\s*=\s*(req\.(params|query|body)|request\.(args|form|json))`
**Type**: regex
**Severity**: high
**Languages**: [python, javascript, typescript]
- User ID directly from request
- CWE-639: IDOR / BOLA

### Session Security Patterns

#### localStorage Token Storage
**Pattern**: `localStorage\.setItem\s*\([^,]*['\"]?(auth|token|session|jwt)['\"]?`
**Type**: regex
**Severity**: medium
**Languages**: [javascript, typescript]
- Auth token in localStorage (XSS accessible)
- CWE-922: Insecure Storage

#### Session Without Regeneration
**Pattern**: `session\[['\"]user['\"]]\s*=(?!.*regenerate|clear|new_)`
**Type**: regex
**Severity**: medium
**Languages**: [python, javascript, typescript]
- Session assignment without regeneration
- CWE-384: Session Fixation

### Privilege Escalation Patterns

#### Role from Client Header
**Pattern**: `(role|isAdmin|permission)\s*=\s*(request\.headers|req\.headers)`
**Type**: regex
**Severity**: critical
**Languages**: [python, javascript, typescript]
- Role/permission from client header
- CWE-269: Privilege Escalation

#### Trust Client Role
**Pattern**: `X-User-Role|X-Admin|X-Permission`
**Type**: regex
**Severity**: high
**Languages**: [python, javascript, typescript]
- Custom headers for authorization
- CWE-269: Privilege Escalation
