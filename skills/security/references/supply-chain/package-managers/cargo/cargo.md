# Cargo Package Manager

**Ecosystem**: Rust
**Package Registry**: https://crates.io
**Documentation**: https://doc.rust-lang.org/cargo/

---

## TIER 1: Manifest Detection

### Manifest Files

| File | Required | Description |
|------|----------|-------------|
| `Cargo.toml` | Yes | Primary manifest |
| `.cargo/config.toml` | No | Cargo configuration |

### Cargo.toml Detection

**Pattern**: `Cargo\.toml$`
**Confidence**: 98% (HIGH)

### Required Sections for SBOM

```toml
[package]
name = "my-crate"
version = "0.1.0"
edition = "2021"

[dependencies]
serde = "1.0"
tokio = { version = "1.32", features = ["full"] }

[dev-dependencies]
proptest = "1.2"

[build-dependencies]
cc = "1.0"
```

### Dependency Types

| Section | Included in SBOM | Notes |
|---------|------------------|-------|
| `[dependencies]` | Yes (always) | Production runtime |
| `[dev-dependencies]` | Configurable | Testing/development |
| `[build-dependencies]` | Configurable | Build scripts |
| `[target.'cfg(...)'.dependencies]` | Conditional | Platform-specific |

---

## TIER 2: Lock File Detection

### Lock File

| File | Format | Version |
|------|--------|---------|
| `Cargo.lock` | TOML | 3 |

**Pattern**: `Cargo\.lock$`
**Confidence**: 98% (HIGH)

### Lock File Structure

```toml
# This file is automatically @generated by Cargo.
# It is not intended for manual editing.
version = 3

[[package]]
name = "serde"
version = "1.0.188"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "cf9e0fcba69a370eed61bcf2b728575f726b50b55cba78064753d708ddc7549e"
dependencies = [
 "serde_derive",
]

[[package]]
name = "serde_derive"
version = "1.0.188"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "4eca7ac642d82aa35b60049a6eccb4be6be75e599bd2e9adb5f875a737654af2"
dependencies = [
 "proc-macro2",
 "quote",
 "syn",
]
```

### Key Lock File Fields

| Field | SBOM Use |
|-------|----------|
| `name` | Crate identifier |
| `version` | Exact version |
| `source` | Registry or git URL |
| `checksum` | SHA-256 hash |
| `dependencies` | Transitive dependencies |

---

## TIER 3: Configuration Extraction

### Registry Configuration

**File**: `.cargo/config.toml`

**Pattern**: `index\s*=\s*['"]([^'"]+)['"]`
**Context**: `[registries.*]`

### Common Configuration

```toml
# .cargo/config.toml

# Custom registry
[registries]
my-registry = { index = "https://my-registry.com/index" }

# Source replacement
[source.crates-io]
replace-with = "vendored-sources"

[source.vendored-sources]
directory = "vendor"

# Private git dependencies
[net]
git-fetch-with-cli = true
```

### Environment Variables

| Variable | Purpose |
|----------|---------|
| `CARGO_HOME` | Cargo installation directory |
| `CARGO_REGISTRY_TOKEN` | crates.io authentication |
| `CARGO_NET_GIT_FETCH_WITH_CLI` | Use git CLI for fetches |

---

## SBOM Generation

### Using cargo-cyclonedx

```bash
# Install plugin
cargo install cargo-cyclonedx

# Generate SBOM
cargo cyclonedx --output-cdx sbom.json

# Exclude dev dependencies
cargo cyclonedx --no-dev

# Specific format
cargo cyclonedx --format json --spec-version 1.5
```

### Using cdxgen

```bash
# Install cdxgen
npm install -g @cyclonedx/cdxgen

# Generate SBOM
cdxgen -o sbom.json

# From Cargo.lock only
cdxgen --project-type cargo -o sbom.json
```

### Using cdxgen (alternative)

```bash
# Generate from directory
cdxgen -o sbom.json

# Specify type
cdxgen -t rust -o sbom.json
```

### Configuration Options

| Option | Description | Default |
|--------|-------------|---------|
| `--no-dev` | Exclude dev-dependencies | Include all |
| `--all-features` | Include all feature dependencies | Default features |
| `--no-default-features` | Exclude default features | Include |
| `--features "..."` | Specific features | Default |

---

## Cache Locations

| Location | Path |
|----------|------|
| Registry Index | `~/.cargo/registry/index/` |
| Downloaded Crates | `~/.cargo/registry/cache/` |
| Extracted Sources | `~/.cargo/registry/src/` |
| Git Dependencies | `~/.cargo/git/` |
| Build Artifacts | `target/` |

```bash
# Find CARGO_HOME
echo $CARGO_HOME || echo ~/.cargo
```

---

## Best Practices Detection

Patterns to detect good dependency management practices in CI/CD, Makefiles, and scripts.

### cargo build --locked
**Pattern**: `cargo\s+(build|test|run)\s+.*--locked`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Enforces exact versions from Cargo.lock
- Ensures reproducible builds

### cargo audit
**Pattern**: `cargo\s+audit`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Vulnerability scanning for Rust dependencies
- Uses RustSec advisory database

### cargo deny
**Pattern**: `cargo\s+deny`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Comprehensive dependency checking
- Licenses, bans, advisories, sources

### cargo vet
**Pattern**: `cargo\s+vet`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Supply chain security verification
- Third-party crate auditing

### cargo vendor
**Pattern**: `cargo\s+vendor`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Vendoring dependencies for air-gapped builds
- Reproducible offline builds

### cargo generate-lockfile
**Pattern**: `cargo\s+generate-lockfile`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Generating lock file explicitly

### cargo update dry-run
**Pattern**: `cargo\s+update\s+--dry-run`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Checking for available updates without applying

### cargo clippy
**Pattern**: `cargo\s+clippy`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Linting Rust code for common mistakes
- Security-relevant lint checks

### cargo fmt check
**Pattern**: `cargo\s+fmt\s+.*--check`
**Type**: regex
**Severity**: info
**Context**: CI/CD, Makefile, scripts
- Enforcing code formatting in CI

---

## Anti-Patterns Detection

Patterns that indicate potential issues.

### Cargo.lock in gitignore for binaries
**Pattern**: `Cargo\.lock` in `.gitignore`
**Type**: regex
**Severity**: medium
**Context**: .gitignore
- Cargo.lock should be committed for applications/binaries
- Note: OK for libraries

### Wildcard dependencies
**Pattern**: `=\s*"\*"`
**Type**: regex
**Severity**: high
**Context**: Cargo.toml
- Using wildcard versions is dangerous
- Non-reproducible dependency resolution

### Git dependencies without rev
**Pattern**: `git\s*=\s*"[^"]+"\s*(?!.*rev)`
**Type**: regex
**Severity**: medium
**Context**: Cargo.toml
- Git dependencies without pinned revision
- May pull unexpected changes

### Insecure git over HTTP
**Pattern**: `git\s*=\s*"http://`
**Type**: regex
**Severity**: high
**Context**: Cargo.toml
- Using HTTP for git dependencies
- Vulnerable to MITM attacks

### Skip verification
**Pattern**: `CARGO_NET_GIT_FETCH_WITH_CLI.*=.*true`
**Type**: regex
**Severity**: low
**Context**: CI/CD, environment
- May bypass Cargo's built-in security checks
- Can be legitimate for private repos

---

## Best Practices Summary

1. **Always commit Cargo.lock** for applications (not libraries)
2. **Use `--locked` flag** in CI/CD to enforce lock file
3. **Vendor dependencies** for air-gapped builds
4. **Use `cargo audit`** for vulnerability scanning
5. **Enable feature unification** awareness in SBOM
6. **Sign crates** using cargo-vet or similar

### Cargo.lock for Libraries vs Applications

| Project Type | Commit Cargo.lock? |
|--------------|-------------------|
| Binary/Application | Yes |
| Library | No (let consumers resolve) |

---

## Troubleshooting

### Missing Lock File
```bash
# Generate lock file
cargo generate-lockfile
```

### Lock File Out of Sync
```bash
# Update lock file
cargo update

# Update specific package
cargo update -p serde
```

### Build Failures with --locked
```bash
# Check what changed
cargo update --dry-run

# Regenerate lock file
rm Cargo.lock
cargo generate-lockfile
```

### Private Registry
```bash
# Configure registry
cargo login --registry my-registry

# Or in .cargo/config.toml
# [registries.my-registry]
# index = "https://my-registry.com/index"
# token = "..."
```

---

## Feature Detection

Cargo features affect dependency resolution:

```toml
[features]
default = ["std"]
std = []
serde = ["dep:serde"]

[dependencies]
serde = { version = "1.0", optional = true }
```

**Pattern for Feature Detection**:
```
\[features\][\s\S]*?(?=\[|\z)
```

---

## References

- [Cargo Documentation](https://doc.rust-lang.org/cargo/)
- [Cargo.lock Format](https://doc.rust-lang.org/cargo/reference/cargo-toml-vs-cargo-lock.html)
- [cargo-cyclonedx](https://github.com/CycloneDX/cyclonedx-rust-cargo)
- [cargo-audit](https://github.com/RustSec/rustsec/tree/main/cargo-audit)
