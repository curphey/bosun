<!--
Copyright (c) 2025 Crash Override Inc. - https://crashoverride.com

SPDX-License-Identifier: GPL-3.0
-->

# Injection Vulnerability Patterns

## SQL Injection (CWE-89)

### Description
SQL injection occurs when user input is incorporated into SQL queries without proper sanitization, allowing attackers to modify query logic.

### Dangerous Patterns

**String Concatenation**
```python
# Python - VULNERABLE
query = "SELECT * FROM users WHERE id = " + user_id
cursor.execute(query)

# Python - VULNERABLE
query = f"SELECT * FROM users WHERE name = '{name}'"
cursor.execute(query)
```

```javascript
// JavaScript - VULNERABLE
const query = `SELECT * FROM users WHERE id = ${userId}`;
db.query(query);

// JavaScript - VULNERABLE
const query = "SELECT * FROM users WHERE name = '" + name + "'";
```

```java
// Java - VULNERABLE
String query = "SELECT * FROM users WHERE id = " + userId;
statement.executeQuery(query);
```

```go
// Go - VULNERABLE
query := "SELECT * FROM users WHERE id = " + userId
db.Query(query)
```

### Safe Patterns

**Parameterized Queries**
```python
# Python - SECURE
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))

# Python with SQLAlchemy - SECURE
User.query.filter_by(id=user_id).first()
```

```javascript
// JavaScript - SECURE
db.query('SELECT * FROM users WHERE id = $1', [userId]);

// With ORM (Sequelize) - SECURE
User.findOne({ where: { id: userId } });
```

```java
// Java - SECURE
PreparedStatement ps = conn.prepareStatement("SELECT * FROM users WHERE id = ?");
ps.setInt(1, userId);
ResultSet rs = ps.executeQuery();
```

```go
// Go - SECURE
db.Query("SELECT * FROM users WHERE id = $1", userId)
```

### Detection Patterns

#### SQL String Concatenation
**Pattern**: `(execute|query|raw)\s*\([^)]*(\+|\.format\(|%s|%d)`
**Type**: regex
**Severity**: critical
**Languages**: [python, javascript, typescript, java, go]
- String concatenation in SQL query
- CWE-89: SQL Injection

#### Python f-string SQL
**Pattern**: `(execute|cursor|query)\s*\(.*f['\"].*SELECT.*FROM`
**Type**: regex
**Severity**: critical
**Languages**: [python]
- Python f-string in SQL query
- CWE-89: SQL Injection

#### JavaScript Template Literal SQL
**Pattern**: `(query|execute)\s*\([^)]*\$\{[^}]*(SELECT|INSERT|UPDATE|DELETE)`
**Type**: regex
**Severity**: critical
**Languages**: [javascript, typescript]
- Template literal in SQL query
- CWE-89: SQL Injection

#### Java String Concat SQL
**Pattern**: `(executeQuery|executeUpdate|execute)\s*\([^)]*\+[^)]*\)`
**Type**: regex
**Severity**: critical
**Languages**: [java]
- String concatenation in Java SQL
- CWE-89: SQL Injection

---

## Command Injection (CWE-78)

### Description
Command injection occurs when user input is passed to system commands, allowing attackers to execute arbitrary commands.

### Dangerous Patterns

```python
# Python - VULNERABLE
import os
os.system(f"ping {host}")

import subprocess
subprocess.call("ping " + host, shell=True)
```

```javascript
// JavaScript - VULNERABLE
const { exec } = require('child_process');
exec(`ls ${userDir}`);

exec('cat ' + filename);
```

```java
// Java - VULNERABLE
Runtime.getRuntime().exec("ping " + host);

ProcessBuilder pb = new ProcessBuilder("sh", "-c", "ping " + host);
```

```go
// Go - VULNERABLE
exec.Command("sh", "-c", "ping "+host).Run()
```

### Safe Patterns

```python
# Python - SECURE
import subprocess
subprocess.run(["ping", "-c", "4", host], shell=False, check=True)

# With input validation
import re
if re.match(r'^[a-zA-Z0-9.-]+$', host):
    subprocess.run(["ping", "-c", "4", host])
```

```javascript
// JavaScript - SECURE
const { execFile } = require('child_process');
execFile('ls', [userDir]);

// With spawn (no shell)
const { spawn } = require('child_process');
spawn('ping', ['-c', '4', host]);
```

```java
// Java - SECURE
ProcessBuilder pb = new ProcessBuilder("ping", "-c", "4", host);
pb.start();
```

```go
// Go - SECURE
exec.Command("ping", "-c", "4", host).Run()
```

### Detection Patterns

#### Python os.system
**Pattern**: `os\.system\s*\([^)]*(\+|f['\"]|\.format\(|%s)`
**Type**: regex
**Severity**: critical
**Languages**: [python]
- os.system with string interpolation
- CWE-78: Command Injection

#### Python subprocess shell=True
**Pattern**: `subprocess\.(call|run|Popen)\s*\([^)]*shell\s*=\s*True`
**Type**: regex
**Severity**: high
**Languages**: [python]
- subprocess with shell=True
- CWE-78: Command Injection

#### JavaScript exec
**Pattern**: `(exec|execSync)\s*\([^)]*(\+|\$\{)`
**Type**: regex
**Severity**: critical
**Languages**: [javascript, typescript]
- child_process exec with interpolation
- CWE-78: Command Injection

#### Java Runtime.exec
**Pattern**: `Runtime\.getRuntime\(\)\.exec\s*\([^)]*\+`
**Type**: regex
**Severity**: critical
**Languages**: [java]
- Runtime.exec with concatenation
- CWE-78: Command Injection

#### Go exec.Command with sh -c
**Pattern**: `exec\.Command\s*\(\s*['\"]sh['\"],\s*['\"]+-c['\"],.*\+`
**Type**: regex
**Severity**: critical
**Languages**: [go]
- Go exec with shell and concatenation
- CWE-78: Command Injection

---

## Cross-Site Scripting - XSS (CWE-79)

### Description
XSS occurs when user input is rendered in HTML without proper encoding, allowing attackers to inject malicious scripts.

### Dangerous Patterns

**Reflected/Stored XSS**
```javascript
// JavaScript - VULNERABLE
element.innerHTML = userInput;
document.write(userInput);

// jQuery - VULNERABLE
$('#content').html(userInput);
```

```python
# Python/Flask - VULNERABLE (with |safe filter)
return render_template('page.html', content=user_input)
# template: {{ content|safe }}

# Django - VULNERABLE
return HttpResponse(f"<div>{user_input}</div>")
```

```java
// Java/JSP - VULNERABLE
out.println("<div>" + userInput + "</div>");
```

### Safe Patterns

```javascript
// JavaScript - SECURE
element.textContent = userInput;

// With sanitization library
import DOMPurify from 'dompurify';
element.innerHTML = DOMPurify.sanitize(userInput);

// React - automatically escapes
return <div>{userInput}</div>;
```

```python
# Python/Flask - SECURE (auto-escaping)
return render_template('page.html', content=user_input)
# template: {{ content }}  (no |safe)

# Manual escaping
from markupsafe import escape
return f"<div>{escape(user_input)}</div>"
```

```java
// Java - SECURE
import org.owasp.encoder.Encode;
out.println("<div>" + Encode.forHtml(userInput) + "</div>");
```

### Detection Patterns

#### innerHTML Assignment
**Pattern**: `\.innerHTML\s*=\s*[^;]*(\+|\$\{|userInput|req\.|request\.)`
**Type**: regex
**Severity**: high
**Languages**: [javascript, typescript]
- innerHTML with user-controlled data
- CWE-79: Cross-site Scripting (XSS)

#### document.write
**Pattern**: `document\.write\s*\([^)]*(\+|\$\{|userInput)`
**Type**: regex
**Severity**: high
**Languages**: [javascript, typescript]
- document.write with dynamic content
- CWE-79: Cross-site Scripting (XSS)

#### jQuery html()
**Pattern**: `\$\([^)]+\)\.html\s*\([^)]*(\+|\$\{|userInput|req\.|data\.)`
**Type**: regex
**Severity**: high
**Languages**: [javascript, typescript]
- jQuery .html() with user data
- CWE-79: Cross-site Scripting (XSS)

#### Flask |safe Filter
**Pattern**: `\{\{.*\|safe\s*\}\}`
**Type**: regex
**Severity**: high
**Languages**: [html]
- Flask template with |safe filter
- CWE-79: Cross-site Scripting (XSS)

#### Django autoescape off
**Pattern**: `\{%\s*autoescape\s+off\s*%\}`
**Type**: regex
**Severity**: high
**Languages**: [html]
- Django template with autoescape disabled
- CWE-79: Cross-site Scripting (XSS)

---

## LDAP Injection (CWE-90)

### Dangerous Patterns
```python
# VULNERABLE
ldap_filter = f"(&(uid={username})(userPassword={password}))"
ldap_conn.search(base_dn, ldap_filter)
```

### Safe Patterns
```python
# SECURE - escape special characters
from ldap3.utils.conv import escape_filter_chars
safe_username = escape_filter_chars(username)
ldap_filter = f"(&(uid={safe_username}))"
```

---

## XPath Injection (CWE-91)

### Dangerous Patterns
```python
# VULNERABLE
xpath = f"//users/user[name='{username}']"
tree.xpath(xpath)
```

### Safe Patterns
```python
# SECURE - parameterized XPath
tree.xpath("//users/user[name=$name]", name=username)
```

---

## Detection Patterns Summary

### LDAP Injection Patterns

#### LDAP Filter f-string
**Pattern**: `f['\"].*\(&?\([a-zA-Z]+=['\"]?\{`
**Type**: regex
**Severity**: high
**Languages**: [python]
- LDAP filter with f-string interpolation
- CWE-90: LDAP Injection

#### LDAP Search Concatenation
**Pattern**: `\.search\s*\([^,]+,\s*[^)]*(\+|f['\"]|\.format)`
**Type**: regex
**Severity**: high
**Languages**: [python, java]
- LDAP search with string concatenation
- CWE-90: LDAP Injection

### XPath Injection Patterns

#### XPath f-string
**Pattern**: `f['\"].*//.*\[.*=.*\{`
**Type**: regex
**Severity**: high
**Languages**: [python]
- XPath with f-string interpolation
- CWE-91: XPath Injection

#### XPath Concatenation
**Pattern**: `\.xpath\s*\([^)]*(\+|\.format\(|f['\"])`
**Type**: regex
**Severity**: high
**Languages**: [python, java]
- XPath query with string interpolation
- CWE-91: XPath Injection

### Eval/Exec Patterns

#### Python eval
**Pattern**: `eval\s*\([^)]*(\+|f['\"]|request\.|req\.|input\()`
**Type**: regex
**Severity**: critical
**Languages**: [python]
- eval() with user input
- CWE-94: Code Injection

#### Python exec
**Pattern**: `exec\s*\([^)]*(\+|f['\"]|request\.|req\.|input\()`
**Type**: regex
**Severity**: critical
**Languages**: [python]
- exec() with user input
- CWE-94: Code Injection

#### JavaScript eval
**Pattern**: `eval\s*\([^)]*(\+|\$\{|req\.|request\.)`
**Type**: regex
**Severity**: critical
**Languages**: [javascript, typescript]
- eval() with user input
- CWE-94: Code Injection

---

## C# Injection Patterns

### SQL Injection

#### C# String Concat SQL
**Pattern**: `(ExecuteReader|ExecuteNonQuery|ExecuteScalar)\s*\([^)]*\+`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- SQL command with string concatenation
- CWE-89: SQL Injection

#### C# String Interpolation SQL
**Pattern**: `SqlCommand\s*\([^)]*\$['\"].*SELECT`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- SqlCommand with string interpolation
- CWE-89: SQL Injection

#### C# String Format SQL
**Pattern**: `(ExecuteReader|ExecuteNonQuery|ExecuteScalar|SqlCommand)\s*\([^)]*String\.Format`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- SQL with String.Format
- CWE-89: SQL Injection

### Command Injection

#### C# Process.Start Shell
**Pattern**: `Process\.Start\s*\([^)]*(\+|\$['\"]|String\.Format)`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- Process.Start with dynamic arguments
- CWE-78: Command Injection

#### C# ProcessStartInfo
**Pattern**: `ProcessStartInfo.*Arguments\s*=\s*[^;]*(\+|\$['\"]|String\.Format)`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- ProcessStartInfo with dynamic arguments
- CWE-78: Command Injection

#### C# cmd.exe /c
**Pattern**: `cmd\.exe.*['\"]?\s*/c.*(\+|\$\{|\$['\"])`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- cmd.exe with dynamic command
- CWE-78: Command Injection

### XSS Patterns

#### C# Response.Write
**Pattern**: `Response\.Write\s*\([^)]*(\+|\$['\"]|Request\[|Request\.)`
**Type**: regex
**Severity**: high
**Languages**: [csharp]
- Response.Write with user input
- CWE-79: Cross-site Scripting (XSS)

#### C# HtmlString Raw
**Pattern**: `HtmlString\s*\([^)]*(\+|\$['\"]|Request\.|Model\.)`
**Type**: regex
**Severity**: high
**Languages**: [csharp]
- HtmlString with unescaped content
- CWE-79: Cross-site Scripting (XSS)

#### ASP.NET Raw
**Pattern**: `@Html\.Raw\s*\([^)]*Model\.`
**Type**: regex
**Severity**: high
**Languages**: [csharp]
- Razor Html.Raw with model data
- CWE-79: Cross-site Scripting (XSS)

### LDAP Injection

#### C# DirectorySearcher
**Pattern**: `DirectorySearcher.*Filter\s*=\s*[^;]*(\+|\$['\"]|String\.Format)`
**Type**: regex
**Severity**: high
**Languages**: [csharp]
- LDAP DirectorySearcher with dynamic filter
- CWE-90: LDAP Injection

### Path Traversal

#### C# File Path Concat
**Pattern**: `(File\.ReadAllText|File\.WriteAllText|File\.Open|StreamReader|StreamWriter)\s*\([^)]*(\+|\$['\"]|Path\.Combine.*Request\.)`
**Type**: regex
**Severity**: high
**Languages**: [csharp]
- File operation with user-controlled path
- CWE-22: Path Traversal

### XML/XPath Injection

#### C# XPath Injection
**Pattern**: `SelectNodes\s*\([^)]*(\+|\$['\"]|String\.Format)`
**Type**: regex
**Severity**: high
**Languages**: [csharp]
- XPath query with dynamic input
- CWE-91: XPath Injection

#### C# XML External Entity
**Pattern**: `XmlReaderSettings.*DtdProcessing\s*=\s*DtdProcessing\.Parse`
**Type**: regex
**Severity**: critical
**Languages**: [csharp]
- XML parser with DTD processing enabled
- CWE-611: XML External Entity (XXE)
