#!/usr/bin/env bash
#
# Bosun pre-commit hook
# Runs quick security and quality checks before committing
#
# Installation:
#   cp hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use: ./scripts/install-hooks.sh

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Bosun pre-commit checks...${NC}"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No staged files to check${NC}"
    exit 0
fi

ERRORS=0

# Check for secrets in staged files
check_secrets() {
    echo "Checking for secrets..."

    # Common secret patterns
    PATTERNS=(
        'API[_-]?KEY\s*[:=]\s*["\047][^"\047]{10,}'
        'SECRET[_-]?KEY\s*[:=]\s*["\047][^"\047]{10,}'
        'PASSWORD\s*[:=]\s*["\047][^"\047]{4,}'
        'PRIVATE[_-]?KEY'
        'BEGIN RSA PRIVATE KEY'
        'BEGIN OPENSSH PRIVATE KEY'
        'ghp_[a-zA-Z0-9]{36}'           # GitHub personal access token
        'gho_[a-zA-Z0-9]{36}'           # GitHub OAuth token
        'ghu_[a-zA-Z0-9]{36}'           # GitHub user token
        'ghs_[a-zA-Z0-9]{36}'           # GitHub server token
        'github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59}'  # GitHub fine-grained PAT
        'sk-[a-zA-Z0-9]{48}'            # OpenAI API key
        'sk-proj-[a-zA-Z0-9-]{48}'      # OpenAI project key
        'AKIA[0-9A-Z]{16}'              # AWS access key
        'xox[baprs]-[0-9a-zA-Z-]{10,}' # Slack tokens
    )

    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            for pattern in "${PATTERNS[@]}"; do
                if grep -qE "$pattern" "$file" 2>/dev/null; then
                    echo -e "${RED}Potential secret found in $file${NC}"
                    ERRORS=$((ERRORS + 1))
                fi
            done
        fi
    done
}

# Check for debug statements
check_debug() {
    echo "Checking for debug statements..."

    DEBUG_PATTERNS=(
        'console\.log\('
        'debugger;'
        'print\s*\('
        'fmt\.Print'
        'System\.out\.print'
    )

    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            # Skip test files
            if [[ "$file" == *test* ]] || [[ "$file" == *spec* ]]; then
                continue
            fi

            for pattern in "${DEBUG_PATTERNS[@]}"; do
                if grep -qE "$pattern" "$file" 2>/dev/null; then
                    echo -e "${YELLOW}Debug statement found in $file (consider removing)${NC}"
                fi
            done
        fi
    done
}

# Check for large files
check_file_size() {
    echo "Checking file sizes..."
    MAX_SIZE=1048576  # 1MB

    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
            if [ "$SIZE" -gt "$MAX_SIZE" ]; then
                echo -e "${RED}Large file detected: $file ($(numfmt --to=iec $SIZE 2>/dev/null || echo "${SIZE} bytes"))${NC}"
                ERRORS=$((ERRORS + 1))
            fi
        fi
    done
}

# Check for common issues in specific file types
check_file_types() {
    echo "Checking file-specific issues..."

    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            case "$file" in
                *.env|*.env.*)
                    echo -e "${RED}Attempting to commit env file: $file${NC}"
                    ERRORS=$((ERRORS + 1))
                    ;;
                *.pem|*.key|*.p12|*.pfx)
                    echo -e "${RED}Attempting to commit key file: $file${NC}"
                    ERRORS=$((ERRORS + 1))
                    ;;
                *credentials*|*secrets*)
                    echo -e "${YELLOW}Suspicious filename: $file (verify no secrets)${NC}"
                    ;;
            esac
        fi
    done
}

# Run checks
check_secrets
check_debug
check_file_size
check_file_types

# Summary
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}Pre-commit checks failed with $ERRORS error(s)${NC}"
    echo -e "${YELLOW}To bypass (not recommended): git commit --no-verify${NC}"
    exit 1
else
    echo -e "${GREEN}All pre-commit checks passed${NC}"
    exit 0
fi
